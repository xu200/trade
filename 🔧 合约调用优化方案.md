# ğŸ”§ åˆçº¦è°ƒç”¨ä¼˜åŒ–æ–¹æ¡ˆ - ç»•è¿‡MetaMaskç¼“å­˜é—®é¢˜

## ğŸ“‹ é—®é¢˜å›é¡¾

### åŸå§‹é—®é¢˜
```
MetaMask - RPC Error: insufficient funds for gas * price + value: 
address 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 have 0 want 1000000000000000000
```

- **ç°è±¡**: ç‚¹å‡»"åˆ›å»ºåº”æ”¶è´¦æ¬¾"åï¼ŒMetaMaskä¸å¼¹å‡º
- **æ ¹æœ¬åŸå› **: MetaMaskç¼“å­˜äº†æ—§çš„HardhatèŠ‚ç‚¹çŠ¶æ€ï¼Œå¯¼è‡´ä½™é¢æ˜¾ç¤ºä¸º0
- **æŠ€æœ¯åŸå› **: ethers.js åœ¨å‘é€äº¤æ˜“å‰ä¼šè°ƒç”¨ `eth_estimateGas` ä¼°ç®—gasï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæ¨¡æ‹Ÿæ‰§è¡Œäº¤æ˜“ï¼Œå¦‚æœæ¨¡æ‹Ÿå¤±è´¥ï¼ˆä½™é¢ä¸è¶³ï¼‰ï¼Œå°±ä¼šç›´æ¥æŠ›å‡ºé”™è¯¯ï¼ŒMetaMaskçª—å£æ ¹æœ¬æ²¡æœ‰æœºä¼šå¼¹å‡º

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**ä¸ä¾èµ–MetaMaskçš„ç¼“å­˜çŠ¶æ€ï¼Œè€Œæ˜¯ï¼š**

1. **ä½¿ç”¨ç‹¬ç«‹çš„ `JsonRpcProvider` ç›´æ¥æŸ¥è¯¢HardhatèŠ‚ç‚¹çš„çœŸå®ä½™é¢**
2. **æ‰‹åŠ¨è®¾ç½®gaså‚æ•°ï¼ˆgasLimit + gasPriceï¼‰**
3. **è·³è¿‡ `eth_estimateGas`ï¼Œç›´æ¥å‘é€äº¤æ˜“åˆ°MetaMask**

---

## ğŸ”§ æŠ€æœ¯å®ç°

### æ—§æ–¹æ³•ï¼ˆæœ‰é—®é¢˜ï¼‰

```typescript
// âŒ æ—§æ–¹æ³•ï¼šä¾èµ–MetaMaskçš„BrowserProvider
const tx = await this.contract!.createReceivable(
  supplier,
  amountWei,
  dueTime,
  description,
  contractNumber,
  { value: amountWei }
);
```

**æ‰§è¡Œæµç¨‹**:
```
è°ƒç”¨ contract.createReceivable(...)
    â†“
ethers.js è‡ªåŠ¨è°ƒç”¨ eth_estimateGas
    â†“
ä½¿ç”¨ BrowserProvider (MetaMask) æŸ¥è¯¢ä½™é¢
    â†“
MetaMaskè¿”å›ç¼“å­˜çš„ä½™é¢: 0 ETH âŒ
    â†“
estimateGas å¤±è´¥: INSUFFICIENT_FUNDS
    â†“
ç›´æ¥æŠ›å‡ºé”™è¯¯ï¼ŒMetaMaskä¸å¼¹å‡º âŒ
```

---

### æ–°æ–¹æ³•ï¼ˆå·²ä¼˜åŒ–ï¼‰

```typescript
// âœ… æ–°æ–¹æ³•ï¼šä½¿ç”¨ç‹¬ç«‹çš„JsonRpcProvider
const rpcProvider = new ethers.JsonRpcProvider('http://localhost:8545');
const signer = await this.provider!.getSigner();
const userAddress = await signer.getAddress();

// 1. æŸ¥è¯¢çœŸå®ä½™é¢
const realBalance = await rpcProvider.getBalance(userAddress);
console.log('ğŸ” çœŸå®ä½™é¢æ£€æŸ¥:', {
  address: userAddress,
  balance: ethers.formatEther(realBalance) + ' ETH',
  required: ethAmount + ' ETH',
  sufficient: realBalance >= amountWei
});

if (realBalance < amountWei) {
  throw new Error(`ä½™é¢ä¸è¶³ï¼å½“å‰ä½™é¢: ${ethers.formatEther(realBalance)} ETH`);
}

// 2. æ‰‹åŠ¨è®¾ç½®gaså‚æ•°
const txParams = {
  value: amountWei,
  gasLimit: 500000n,  // æ‰‹åŠ¨è®¾ç½®è¶³å¤Ÿçš„gas limit
  gasPrice: await rpcProvider.getFeeData().then(fee => fee.gasPrice || 0n)
};

console.log('ğŸ“¤ å‘é€äº¤æ˜“åˆ°MetaMask...', txParams);

// 3. å‘é€äº¤æ˜“ï¼ˆè·³è¿‡estimateGasï¼‰
const tx = await this.contract!.createReceivable(
  supplier,
  amountWei,
  dueTime,
  description,
  contractNumber,
  txParams  // â­ å…³é”®ï¼šæ‰‹åŠ¨æŒ‡å®šgaså‚æ•°
);
```

**æ‰§è¡Œæµç¨‹**:
```
1. JsonRpcProvider ç›´æ¥æŸ¥è¯¢èŠ‚ç‚¹ä½™é¢ âœ…
    â†“
2. éªŒè¯ä½™é¢å……è¶³ âœ…
    â†“
3. æ‰‹åŠ¨è®¾ç½® gasLimit + gasPrice âœ…
    â†“
4. å‘é€äº¤æ˜“ï¼ˆè·³è¿‡ estimateGasï¼‰ âœ…
    â†“
5. MetaMask å¼¹å‡ºç¡®è®¤çª—å£ âœ…
    â†“
6. ç”¨æˆ·ç¡®è®¤ï¼Œäº¤æ˜“å‘é€åˆ°åŒºå—é“¾ âœ…
```

---

## ğŸ“ ä¼˜åŒ–çš„æ–¹æ³•åˆ—è¡¨

### 1. `createReceivable()` - åˆ›å»ºåº”æ”¶è´¦æ¬¾

**ä¼˜åŒ–å†…å®¹**:
- ä½¿ç”¨ `JsonRpcProvider` æŸ¥è¯¢çœŸå®ä½™é¢
- æ‰‹åŠ¨è®¾ç½® `gasLimit: 500000n`
- æ‰‹åŠ¨è®¾ç½® `gasPrice`
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

**å…³é”®ä»£ç **:
```typescript
const txParams = {
  value: amountWei,
  gasLimit: 500000n,
  gasPrice: await rpcProvider.getFeeData().then(fee => fee.gasPrice || 0n)
};

const tx = await this.contract!.createReceivable(
  supplier, amountWei, dueTime, description, contractNumber, txParams
);
```

---

### 2. `confirmReceivable()` - ç¡®è®¤åº”æ”¶è´¦æ¬¾

**ä¼˜åŒ–å†…å®¹**:
- æ‰‹åŠ¨è®¾ç½® `gasLimit: 300000n`
- æ‰‹åŠ¨è®¾ç½® `gasPrice`

**å…³é”®ä»£ç **:
```typescript
const rpcProvider = new ethers.JsonRpcProvider('http://localhost:8545');
const txParams = {
  gasLimit: 300000n,
  gasPrice: await rpcProvider.getFeeData().then(fee => fee.gasPrice || 0n)
};

const tx = await this.contract!.confirmReceivable(receivableId, txParams);
```

---

### 3. `transferReceivable()` - è½¬è®©åº”æ”¶è´¦æ¬¾

**ä¼˜åŒ–å†…å®¹**:
- æ‰‹åŠ¨è®¾ç½® `gasLimit: 300000n`
- æ‰‹åŠ¨è®¾ç½® `gasPrice`

**å…³é”®ä»£ç **:
```typescript
const rpcProvider = new ethers.JsonRpcProvider('http://localhost:8545');
const txParams = {
  gasLimit: 300000n,
  gasPrice: await rpcProvider.getFeeData().then(fee => fee.gasPrice || 0n)
};

const tx = await this.contract!.transferReceivable(receivableId, newOwner, txParams);
```

---

### 4. `approveFinanceApplication()` - æ‰¹å‡†èèµ„

**ä¼˜åŒ–å†…å®¹**:
- ä½¿ç”¨ `JsonRpcProvider` æŸ¥è¯¢çœŸå®ä½™é¢
- æ‰‹åŠ¨è®¾ç½® `gasLimit: 500000n`
- æ‰‹åŠ¨è®¾ç½® `gasPrice`
- æ·»åŠ è¯¦ç»†çš„ä½™é¢æ£€æŸ¥æ—¥å¿—

**å…³é”®ä»£ç **:
```typescript
const rpcProvider = new ethers.JsonRpcProvider('http://localhost:8545');
const realBalance = await rpcProvider.getBalance(userAddress);

if (realBalance < amountWei) {
  throw new Error(`ä½™é¢ä¸è¶³ï¼å½“å‰ä½™é¢: ${ethers.formatEther(realBalance)} ETH`);
}

const txParams = {
  value: amountWei,
  gasLimit: 500000n,
  gasPrice: await rpcProvider.getFeeData().then(fee => fee.gasPrice || 0n)
};

const tx = await this.contract!.approveFinanceApplication(appId, true, txParams);
```

---

### 5. `rejectFinanceApplication()` - æ‹’ç»èèµ„

**ä¼˜åŒ–å†…å®¹**:
- æ‰‹åŠ¨è®¾ç½® `gasLimit: 300000n`
- æ‰‹åŠ¨è®¾ç½® `gasPrice`

**å…³é”®ä»£ç **:
```typescript
const rpcProvider = new ethers.JsonRpcProvider('http://localhost:8545');
const txParams = {
  gasLimit: 300000n,
  gasPrice: await rpcProvider.getFeeData().then(fee => fee.gasPrice || 0n)
};

const tx = await this.contract!.approveFinanceApplication(appId, false, txParams);
```

---

## ğŸ¯ å…³é”®æŠ€æœ¯ç‚¹

### 1. JsonRpcProvider vs BrowserProvider

| ç‰¹æ€§ | BrowserProvider | JsonRpcProvider |
|------|-----------------|-----------------|
| æ•°æ®æ¥æº | MetaMask (å¯èƒ½æœ‰ç¼“å­˜) | ç›´æ¥è¿æ¥èŠ‚ç‚¹ |
| ä½™é¢æŸ¥è¯¢ | å¯èƒ½ä¸å‡†ç¡® | å®æ—¶å‡†ç¡® |
| ç”¨é€” | å‘é€äº¤æ˜“ã€ç­¾å | æŸ¥è¯¢é“¾ä¸Šæ•°æ® |

**æœ€ä½³å®è·µ**: 
- æŸ¥è¯¢æ•°æ®ç”¨ `JsonRpcProvider`
- å‘é€äº¤æ˜“ç”¨ `BrowserProvider` (MetaMask)

---

### 2. æ‰‹åŠ¨è®¾ç½®Gaså‚æ•°

```typescript
const txParams = {
  gasLimit: 500000n,  // æ‰‹åŠ¨è®¾ç½®gasä¸Šé™
  gasPrice: await rpcProvider.getFeeData().then(fee => fee.gasPrice || 0n)
};
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ**

- `gasLimit`: æ‰‹åŠ¨æŒ‡å®šè¶³å¤Ÿçš„gasï¼Œè·³è¿‡ `estimateGas`
- `gasPrice`: ä»èŠ‚ç‚¹è·å–å½“å‰gasä»·æ ¼ï¼ˆHardhatæœ¬åœ°ç½‘ç»œé€šå¸¸ä¸º0ï¼‰

**æ•ˆæœ**:
- ethers.js ä¸ä¼šè°ƒç”¨ `eth_estimateGas`
- ç›´æ¥å‘é€äº¤æ˜“åˆ°MetaMask
- MetaMaskå¼¹å‡ºç¡®è®¤çª—å£

---

### 3. æ—¥å¿—è¾“å‡º

ä¼˜åŒ–åçš„ä»£ç æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—ï¼š

```typescript
console.log('ğŸ” çœŸå®ä½™é¢æ£€æŸ¥:', {
  address: userAddress,
  balance: ethers.formatEther(realBalance) + ' ETH',
  required: ethAmount + ' ETH',
  sufficient: realBalance >= amountWei
});

console.log('âš™ï¸ å‡†å¤‡äº¤æ˜“å‚æ•°ï¼ˆæ‰‹åŠ¨è®¾ç½®gasï¼‰...');
console.log('ğŸ“¤ å‘é€äº¤æ˜“åˆ°MetaMask...', txParams);
```

**ç”¨é€”**:
- æ–¹ä¾¿è°ƒè¯•
- ç¡®è®¤ä½™é¢æŸ¥è¯¢æ­£ç¡®
- éªŒè¯gaså‚æ•°è®¾ç½®

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åˆ·æ–°æµè§ˆå™¨

æŒ‰ **Ctrl + Shift + R** å¼ºåˆ¶åˆ·æ–°ï¼ŒåŠ è½½æ–°çš„ä»£ç 

---

### 2. å¡«å†™è¡¨å•å¹¶æäº¤

ä¾‹å¦‚ï¼šåˆ›å»ºåº”æ”¶è´¦æ¬¾

---

### 3. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

```
â›“ï¸ åˆ›å»ºåº”æ”¶è´¦æ¬¾å‚æ•°: {
  supplier: '0x70997970C51812dc3A010C7d01b50e0d17dc79C8',
  amount: '1000000000000000000 Wei (1.0000 ETH)',
  dueTime: 1761494400,
  description: 'è´­ä¹°ETH',
  contractNumber: 'JX-2025-001'
}

ğŸ” çœŸå®ä½™é¢æ£€æŸ¥: {
  address: '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266',
  balance: '9999.xxxx ETH',
  required: '1.0000 ETH',
  sufficient: true
}

âš™ï¸ å‡†å¤‡äº¤æ˜“å‚æ•°ï¼ˆæ‰‹åŠ¨è®¾ç½®gasï¼‰...

ğŸ“¤ å‘é€äº¤æ˜“åˆ°MetaMask... {
  value: 1000000000000000000n,
  gasLimit: 500000n,
  gasPrice: 0n
}
```

---

### 4. MetaMaskå¼¹å‡º

ç°åœ¨åº”è¯¥å¯ä»¥çœ‹åˆ°MetaMaskç¡®è®¤çª—å£äº†ï¼

---

### 5. ç¡®è®¤äº¤æ˜“

ç‚¹å‡»"ç¡®è®¤"ï¼Œäº¤æ˜“å‘é€åˆ°åŒºå—é“¾

---

### 6. æŸ¥çœ‹ç»“æœ

```
âœ… åº”æ”¶è´¦æ¬¾åˆ›å»ºæˆåŠŸ: {
  txHash: '0x...',
  blockNumber: 123
}
```

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“

| æ–¹é¢ | æ—§æ–¹æ³• | æ–°æ–¹æ³• |
|------|--------|--------|
| ä½™é¢æŸ¥è¯¢ | BrowserProvider (MetaMaskç¼“å­˜) | JsonRpcProvider (å®æ—¶) |
| Gasä¼°ç®— | è‡ªåŠ¨è°ƒç”¨ eth_estimateGas | æ‰‹åŠ¨è®¾ç½®gaså‚æ•° |
| å¤±è´¥åŸå›  | estimateGaså¤±è´¥ï¼ŒMetaMaskä¸å¼¹å‡º | è·³è¿‡estimateGasï¼Œç›´æ¥å¼¹å‡º |
| æˆåŠŸç‡ | âŒ ä½ï¼ˆå—ç¼“å­˜å½±å“ï¼‰ | âœ… é«˜ï¼ˆç»•è¿‡ç¼“å­˜ï¼‰ |
| æ—¥å¿—è¾“å‡º | å°‘ | è¯¦ç»† |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Gas Limit è®¾ç½®

- `createReceivable`: `500000n` (éœ€è¦é”å®šETHï¼Œgasæ¶ˆè€—è¾ƒé«˜)
- `approveFinanceApplication`: `500000n` (éœ€è¦è½¬è´¦ETH)
- å…¶ä»–æ–¹æ³•: `300000n` (æ™®é€šäº¤æ˜“)

å¦‚æœäº¤æ˜“å¤±è´¥æç¤º "out of gas"ï¼Œå¯ä»¥é€‚å½“å¢åŠ  `gasLimit`ã€‚

---

### 2. RPC URL

```typescript
const rpcProvider = new ethers.JsonRpcProvider('http://localhost:8545');
```

âš ï¸ **å¿…é¡»æ˜¯ `http://localhost:8545`**ï¼Œä¸è¦ç”¨ `http://127.0.0.1:8545`

è™½ç„¶ä¸¤è€…åº”è¯¥ç›¸åŒï¼Œä½†æœ‰æ—¶æµè§ˆå™¨ä¼šåŒºåˆ«å¯¹å¾…ã€‚

---

### 3. ç”Ÿäº§ç¯å¢ƒ

è¿™ä¸ªæ–¹æ¡ˆä¸»è¦ç”¨äºè§£å†³ **Hardhatæœ¬åœ°å¼€å‘ç¯å¢ƒ** çš„MetaMaskç¼“å­˜é—®é¢˜ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒï¼ˆå¦‚ä»¥å¤ªåŠä¸»ç½‘ã€æµ‹è¯•ç½‘ï¼‰ï¼š
- MetaMaskä¸ä¼šæœ‰ç¼“å­˜é—®é¢˜
- å¯ä»¥ä½¿ç”¨åŸå§‹æ–¹æ³•ï¼ˆè‡ªåŠ¨estimateGasï¼‰
- æˆ–è€…ç»§ç»­ä½¿ç”¨ä¼˜åŒ–æ–¹æ³•ï¼ˆæ›´å¯é ï¼‰

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: è¿˜æ˜¯æ˜¾ç¤ºä½™é¢ä¸è¶³

**æ£€æŸ¥**:
1. æ§åˆ¶å°æ—¥å¿—ä¸­çš„ "çœŸå®ä½™é¢æ£€æŸ¥" æ˜¾ç¤ºçš„ä½™é¢æ˜¯å¤šå°‘ï¼Ÿ
2. HardhatèŠ‚ç‚¹æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Ÿ
3. RPC URL æ˜¯å¦æ­£ç¡®ï¼Ÿ

**è§£å†³**:
```powershell
# æ£€æŸ¥HardhatèŠ‚ç‚¹ä½™é¢
$body = '{"jsonrpc":"2.0","method":"eth_getBalance","params":["0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266","latest"],"id":1}'
Invoke-WebRequest -Uri "http://127.0.0.1:8545" -Method POST -Body $body -ContentType "application/json"
```

---

### é—®é¢˜2: MetaMaskè¿˜æ˜¯ä¸å¼¹å‡º

**æ£€æŸ¥**:
1. æµè§ˆå™¨æ˜¯å¦å¼ºåˆ¶åˆ·æ–°äº†ï¼Ÿï¼ˆCtrl + Shift + Rï¼‰
2. æ§åˆ¶å°æ˜¯å¦æœ‰å…¶ä»–é”™è¯¯ï¼Ÿ
3. MetaMaskæ˜¯å¦å·²è¿æ¥åˆ°Hardhatç½‘ç»œï¼Ÿ

**è§£å†³**:
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- æ£€æŸ¥MetaMaskç½‘ç»œé…ç½®
- æŸ¥çœ‹æ§åˆ¶å°å®Œæ•´é”™è¯¯æ—¥å¿—

---

### é—®é¢˜3: äº¤æ˜“å¤±è´¥ "out of gas"

**åŸå› **: `gasLimit` è®¾ç½®å¤ªå°

**è§£å†³**:
```typescript
const txParams = {
  gasLimit: 1000000n,  // å¢åŠ gas limit
  gasPrice: await rpcProvider.getFeeData().then(fee => fee.gasPrice || 0n)
};
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### ethers.js æ–‡æ¡£

- [JsonRpcProvider](https://docs.ethers.org/v6/api/providers/jsonrpc/)
- [BrowserProvider](https://docs.ethers.org/v6/api/providers/)
- [Transaction Overrides](https://docs.ethers.org/v6/api/contract/#ContractTransaction)

### Hardhat æ–‡æ¡£

- [Hardhat Network](https://hardhat.org/hardhat-network/docs)
- [Console Logging](https://hardhat.org/hardhat-network/docs/reference#console-log)

---

## âœ… æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¼˜åŒ–ï¼Œæˆ‘ä»¬ï¼š

1. âœ… **è§£å†³äº†MetaMaskç¼“å­˜é—®é¢˜** - ä½¿ç”¨ç‹¬ç«‹çš„JsonRpcProvideræŸ¥è¯¢çœŸå®ä½™é¢
2. âœ… **ç»•è¿‡äº†estimateGaså¤±è´¥** - æ‰‹åŠ¨è®¾ç½®gaså‚æ•°ï¼Œè·³è¿‡è‡ªåŠ¨ä¼°ç®—
3. âœ… **æé«˜äº†æˆåŠŸç‡** - ä¸å†ä¾èµ–MetaMaskçš„ç¼“å­˜çŠ¶æ€
4. âœ… **å¢å¼ºäº†å¯è°ƒè¯•æ€§** - æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

ç°åœ¨ï¼Œå³ä½¿MetaMaskæ˜¾ç¤ºä½™é¢ä¸º0ï¼Œåªè¦HardhatèŠ‚ç‚¹ä¸Šæœ‰çœŸå®ä½™é¢ï¼Œäº¤æ˜“å°±èƒ½æˆåŠŸå‘é€ï¼

---

**æœ€åæ›´æ–°**: 2025-10-22

