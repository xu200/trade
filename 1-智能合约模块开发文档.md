# Êô∫ËÉΩÂêàÁ∫¶Ê®°ÂùóÂºÄÂèëÊñáÊ°£

## üìå Ê®°ÂùóÊ¶ÇËø∞

Êô∫ËÉΩÂêàÁ∫¶ÊòØÊï¥‰∏™Á≥ªÁªüÁöÑÊ†∏ÂøÉÔºåË¥üË¥£Âú®Âå∫ÂùóÈìæ‰∏äËÆ∞ÂΩïÂíåÁÆ°ÁêÜÂ∫îÊî∂Ë¥¶Ê¨æÁöÑÁîüÂëΩÂë®ÊúüÔºåÂåÖÊã¨ÂàõÂª∫„ÄÅÁ°ÆËÆ§„ÄÅËΩ¨ËÆ©ÂíåËûçËµÑÊ†áËÆ∞„ÄÇ

---

## üéØ ÂºÄÂèëÁõÆÊ†á

- ÂÆûÁé∞Â∫îÊî∂Ë¥¶Ê¨æÁöÑÈìæ‰∏äÂ≠òÂÇ®ÂíåÁä∂ÊÄÅÁÆ°ÁêÜ
- Á°Æ‰øù‰∫§ÊòìÁöÑ‰∏çÂèØÁØ°ÊîπÊÄßÂíåÂèØËøΩÊ∫ØÊÄß
- Êèê‰æõÊ∏ÖÊô∞ÁöÑÊùÉÈôêÊéßÂà∂Âíå‰∫ã‰ª∂Êó•Âøó
- ‰øùÊåÅÂêàÁ∫¶ÁÆÄÊ¥ÅÈ´òÊïàÔºåÈôç‰Ωé Gas Ë¥πÁî®

---

## üõ†Ô∏è ÊäÄÊúØÊ†à

- **ÂºÄÂèëËØ≠Ë®Ä**: Solidity ^0.8.0
- **ÂºÄÂèëÊ°ÜÊû∂**: Hardhat
- **ÊµãËØïÁΩëÁªú**: Sepolia / Goerli
- **Èí±ÂåÖÂ∑•ÂÖ∑**: MetaMask
- **Â∫ì‰æùËµñ**: OpenZeppelin (ÂèØÈÄâÔºåÁî®‰∫éÂÆâÂÖ®ÊÄßÂ¢ûÂº∫)

---

## üìä Êï∞ÊçÆÁªìÊûÑËÆæËÆ°

### 1. Â∫îÊî∂Ë¥¶Ê¨æÁªìÊûÑ‰Ωì (Receivable)

```solidity
struct Receivable {
    uint256 id;                 // Â∫îÊî∂Ë¥¶Ê¨æÂîØ‰∏ÄID
    address issuer;             // ÂèëË°åÊñπÔºàÊ†∏ÂøÉ‰ºÅ‰∏öÔºâ
    address owner;              // ÂΩìÂâçÊåÅÊúâ‰∫∫ÔºàÂàùÂßã‰∏∫‰æõÂ∫îÂïÜÔºâ
    address supplier;           // ÂéüÂßã‰æõÂ∫îÂïÜÂú∞ÂùÄ
    uint256 amount;             // ÈáëÈ¢ùÔºàÂçï‰ΩçÔºöweiÔºâ
    uint256 createTime;         // ÂàõÂª∫Êó∂Èó¥Êà≥
    uint256 dueTime;            // Âà∞ÊúüÊó∂Èó¥Êà≥
    bool confirmed;             // ÊòØÂê¶Â∑≤Á°ÆËÆ§
    bool financed;              // ÊòØÂê¶Â∑≤ËûçËµÑ
    bool settled;               // ÊòØÂê¶Â∑≤ÁªìÁÆó
    string description;         // ÊèèËø∞‰ø°ÊÅØ
    string contractNumber;      // ÂêàÂêåÁºñÂè∑
}
```

### 2. Áî®Êà∑ËßíËâ≤Êûö‰∏æ

```solidity
enum UserRole {
    NONE,           // Êú™Ê≥®ÂÜå
    CORE_COMPANY,   // Ê†∏ÂøÉ‰ºÅ‰∏ö
    SUPPLIER,       // ‰æõÂ∫îÂïÜ
    FINANCIER       // ÈáëËûçÊú∫ÊûÑ
}
```

### 3. ËûçËµÑÁî≥ËØ∑ÁªìÊûÑ‰Ωì

```solidity
struct FinanceApplication {
    uint256 receivableId;       // ÂÖ≥ËÅîÁöÑÂ∫îÊî∂Ë¥¶Ê¨æID
    address applicant;          // Áî≥ËØ∑‰∫∫
    address financier;          // ÈáëËûçÊú∫ÊûÑ
    uint256 applyTime;          // Áî≥ËØ∑Êó∂Èó¥
    uint256 financeAmount;      // ËûçËµÑÈáëÈ¢ù
    uint256 interestRate;       // Âà©ÁéáÔºàÂü∫ÁÇπÔºåÂ¶Ç500Ë°®Á§∫5%Ôºâ
    bool approved;              // ÊòØÂê¶ÊâπÂáÜ
    bool processed;             // ÊòØÂê¶Â∑≤Â§ÑÁêÜ
}
```

---

## üîß Ê†∏ÂøÉÂäüËÉΩÂÆûÁé∞

### 1. Áî®Êà∑Ê≥®ÂÜå‰∏éËßíËâ≤ÁÆ°ÁêÜ

```solidity
// Áä∂ÊÄÅÂèòÈáè
mapping(address => UserRole) public userRoles;
mapping(address => string) public userNames;

// Ê≥®ÂÜåÁî®Êà∑
function registerUser(UserRole _role, string memory _name) external {
    require(userRoles[msg.sender] == UserRole.NONE, "Already registered");
    require(_role != UserRole.NONE, "Invalid role");
    
    userRoles[msg.sender] = _role;
    userNames[msg.sender] = _name;
    
    emit UserRegistered(msg.sender, _role, _name);
}

// Ëé∑ÂèñÁî®Êà∑ËßíËâ≤
function getUserRole(address _user) external view returns (UserRole) {
    return userRoles[_user];
}
```

### 2. ÂàõÂª∫Â∫îÊî∂Ë¥¶Ê¨æ

```solidity
// Áä∂ÊÄÅÂèòÈáè
uint256 public receivableCounter;
mapping(uint256 => Receivable) public receivables;

// ÂàõÂª∫Â∫îÊî∂Ë¥¶Ê¨æÔºà‰ªÖÊ†∏ÂøÉ‰ºÅ‰∏öÔºâ
function createReceivable(
    address _supplier,
    uint256 _amount,
    uint256 _dueTime,
    string memory _description,
    string memory _contractNumber
) external onlyCoreCompany returns (uint256) {
    require(_supplier != address(0), "Invalid supplier address");
    require(_amount > 0, "Amount must be positive");
    require(_dueTime > block.timestamp, "Due time must be in future");
    
    receivableCounter++;
    uint256 newId = receivableCounter;
    
    receivables[newId] = Receivable({
        id: newId,
        issuer: msg.sender,
        owner: _supplier,
        supplier: _supplier,
        amount: _amount,
        createTime: block.timestamp,
        dueTime: _dueTime,
        confirmed: false,
        financed: false,
        settled: false,
        description: _description,
        contractNumber: _contractNumber
    });
    
    emit ReceivableCreated(newId, msg.sender, _supplier, _amount);
    
    return newId;
}
```

### 3. Á°ÆËÆ§Â∫îÊî∂Ë¥¶Ê¨æ

```solidity
// ‰æõÂ∫îÂïÜÁ°ÆËÆ§Â∫îÊî∂Ë¥¶Ê¨æ
function confirmReceivable(uint256 _id) external {
    Receivable storage rec = receivables[_id];
    
    require(rec.id != 0, "Receivable does not exist");
    require(rec.owner == msg.sender, "Not the owner");
    require(!rec.confirmed, "Already confirmed");
    
    rec.confirmed = true;
    
    emit ReceivableConfirmed(_id, msg.sender);
}
```

### 4. ËΩ¨ËÆ©Â∫îÊî∂Ë¥¶Ê¨æ

```solidity
// ËΩ¨ËÆ©Â∫îÊî∂Ë¥¶Ê¨æ
function transferReceivable(uint256 _id, address _newOwner) external {
    Receivable storage rec = receivables[_id];
    
    require(rec.id != 0, "Receivable does not exist");
    require(rec.owner == msg.sender, "Not the owner");
    require(rec.confirmed, "Not confirmed yet");
    require(!rec.settled, "Already settled");
    require(_newOwner != address(0), "Invalid new owner");
    
    address oldOwner = rec.owner;
    rec.owner = _newOwner;
    
    emit ReceivableTransferred(_id, oldOwner, _newOwner);
}
```

### 5. ËûçËµÑÁî≥ËØ∑‰∏éÂÆ°Êâπ

```solidity
// Áä∂ÊÄÅÂèòÈáè
uint256 public financeApplicationCounter;
mapping(uint256 => FinanceApplication) public financeApplications;
mapping(uint256 => uint256[]) public receivableToApplications;

// Áî≥ËØ∑ËûçËµÑ
function applyForFinance(
    uint256 _receivableId,
    address _financier,
    uint256 _financeAmount,
    uint256 _interestRate
) external returns (uint256) {
    Receivable storage rec = receivables[_receivableId];
    
    require(rec.id != 0, "Receivable does not exist");
    require(rec.owner == msg.sender, "Not the owner");
    require(rec.confirmed, "Not confirmed yet");
    require(!rec.financed, "Already financed");
    require(userRoles[_financier] == UserRole.FINANCIER, "Invalid financier");
    require(_financeAmount <= rec.amount, "Amount exceeds receivable");
    
    financeApplicationCounter++;
    uint256 appId = financeApplicationCounter;
    
    financeApplications[appId] = FinanceApplication({
        receivableId: _receivableId,
        applicant: msg.sender,
        financier: _financier,
        applyTime: block.timestamp,
        financeAmount: _financeAmount,
        interestRate: _interestRate,
        approved: false,
        processed: false
    });
    
    receivableToApplications[_receivableId].push(appId);
    
    emit FinanceApplicationSubmitted(appId, _receivableId, msg.sender, _financier);
    
    return appId;
}

// ÂÆ°ÊâπËûçËµÑÁî≥ËØ∑Ôºà‰ªÖÈáëËûçÊú∫ÊûÑÔºâ
function approveFinanceApplication(uint256 _appId, bool _approve) external {
    FinanceApplication storage app = financeApplications[_appId];
    
    require(app.financier == msg.sender, "Not the assigned financier");
    require(!app.processed, "Already processed");
    
    app.approved = _approve;
    app.processed = true;
    
    if (_approve) {
        Receivable storage rec = receivables[app.receivableId];
        rec.financed = true;
        
        emit FinanceApproved(_appId, app.receivableId);
    } else {
        emit FinanceRejected(_appId, app.receivableId);
    }
}
```

### 6. ÁªìÁÆóÂ∫îÊî∂Ë¥¶Ê¨æ

```solidity
// ÁªìÁÆóÂ∫îÊî∂Ë¥¶Ê¨æÔºà‰ªÖÂèëË°åÊñπÔºâ
function settleReceivable(uint256 _id) external onlyCoreCompany {
    Receivable storage rec = receivables[_id];
    
    require(rec.id != 0, "Receivable does not exist");
    require(rec.issuer == msg.sender, "Not the issuer");
    require(rec.confirmed, "Not confirmed yet");
    require(!rec.settled, "Already settled");
    
    rec.settled = true;
    
    emit ReceivableSettled(_id, rec.owner);
}
```

---

## üîê ÊùÉÈôêÊéßÂà∂ÔºàModifiersÔºâ

```solidity
modifier onlyCoreCompany() {
    require(userRoles[msg.sender] == UserRole.CORE_COMPANY, "Only core company");
    _;
}

modifier onlySupplier() {
    require(userRoles[msg.sender] == UserRole.SUPPLIER, "Only supplier");
    _;
}

modifier onlyFinancier() {
    require(userRoles[msg.sender] == UserRole.FINANCIER, "Only financier");
    _;
}
```

---

## üì¢ ‰∫ã‰ª∂ÂÆö‰πâ

```solidity
event UserRegistered(address indexed user, UserRole role, string name);
event ReceivableCreated(uint256 indexed id, address indexed issuer, address indexed supplier, uint256 amount);
event ReceivableConfirmed(uint256 indexed id, address indexed confirmer);
event ReceivableTransferred(uint256 indexed id, address indexed from, address indexed to);
event FinanceApplicationSubmitted(uint256 indexed appId, uint256 indexed receivableId, address indexed applicant, address financier);
event FinanceApproved(uint256 indexed appId, uint256 indexed receivableId);
event FinanceRejected(uint256 indexed appId, uint256 indexed receivableId);
event ReceivableSettled(uint256 indexed id, address indexed finalOwner);
```

---

## üß™ Êü•ËØ¢ÂáΩÊï∞

```solidity
// Ëé∑ÂèñÂ∫îÊî∂Ë¥¶Ê¨æËØ¶ÊÉÖ
function getReceivable(uint256 _id) external view returns (Receivable memory) {
    return receivables[_id];
}

// Ëé∑ÂèñÁî®Êà∑Êã•ÊúâÁöÑÂ∫îÊî∂Ë¥¶Ê¨æÂàóË°®
function getReceivablesByOwner(address _owner) external view returns (uint256[] memory) {
    uint256[] memory result = new uint256[](receivableCounter);
    uint256 count = 0;
    
    for (uint256 i = 1; i <= receivableCounter; i++) {
        if (receivables[i].owner == _owner) {
            result[count] = i;
            count++;
        }
    }
    
    // Ë∞ÉÊï¥Êï∞ÁªÑÂ§ßÂ∞è
    uint256[] memory finalResult = new uint256[](count);
    for (uint256 i = 0; i < count; i++) {
        finalResult[i] = result[i];
    }
    
    return finalResult;
}

// Ëé∑ÂèñÁî®Êà∑ÂèëË°åÁöÑÂ∫îÊî∂Ë¥¶Ê¨æÂàóË°®
function getReceivablesByIssuer(address _issuer) external view returns (uint256[] memory) {
    uint256[] memory result = new uint256[](receivableCounter);
    uint256 count = 0;
    
    for (uint256 i = 1; i <= receivableCounter; i++) {
        if (receivables[i].issuer == _issuer) {
            result[count] = i;
            count++;
        }
    }
    
    uint256[] memory finalResult = new uint256[](count);
    for (uint256 i = 0; i < count; i++) {
        finalResult[i] = result[i];
    }
    
    return finalResult;
}

// Ëé∑ÂèñËûçËµÑÁî≥ËØ∑ËØ¶ÊÉÖ
function getFinanceApplication(uint256 _appId) external view returns (FinanceApplication memory) {
    return financeApplications[_appId];
}

// Ëé∑ÂèñÂ∫îÊî∂Ë¥¶Ê¨æÁöÑÊâÄÊúâËûçËµÑÁî≥ËØ∑
function getApplicationsByReceivable(uint256 _receivableId) external view returns (uint256[] memory) {
    return receivableToApplications[_receivableId];
}
```

---

## üì¶ Hardhat ÈÖçÁΩÆ

### 1. È°πÁõÆÂàùÂßãÂåñ

```bash
mkdir contracts
cd contracts
npm init -y
npm install --save-dev hardhat @nomicfoundation/hardhat-toolbox
npx hardhat init
```

### 2. hardhat.config.js

```javascript
require("@nomicfoundation/hardhat-toolbox");
require('dotenv').config();

module.exports = {
  solidity: {
    version: "0.8.20",
    settings: {
      optimizer: {
        enabled: true,
        runs: 200
      }
    }
  },
  networks: {
    hardhat: {
      chainId: 1337
    },
    sepolia: {
      url: process.env.SEPOLIA_RPC_URL || "",
      accounts: process.env.PRIVATE_KEY ? [process.env.PRIVATE_KEY] : []
    },
    localhost: {
      url: "http://127.0.0.1:8545"
    }
  },
  paths: {
    sources: "./contracts",
    tests: "./test",
    cache: "./cache",
    artifacts: "./artifacts"
  }
};
```

### 3. ÈÉ®ÁΩ≤ËÑöÊú¨ (scripts/deploy.js)

```javascript
const hre = require("hardhat");

async function main() {
  console.log("ÂºÄÂßãÈÉ®ÁΩ≤ SupplyChainFinance ÂêàÁ∫¶...");

  const SupplyChainFinance = await hre.ethers.getContractFactory("SupplyChainFinance");
  const contract = await SupplyChainFinance.deploy();

  await contract.waitForDeployment();

  const address = await contract.getAddress();
  console.log("ÂêàÁ∫¶ÈÉ®ÁΩ≤ÊàêÂäüÔºÅ");
  console.log("ÂêàÁ∫¶Âú∞ÂùÄ:", address);

  // ‰øùÂ≠òÂêàÁ∫¶Âú∞ÂùÄÂà∞Êñá‰ª∂
  const fs = require('fs');
  const deployInfo = {
    address: address,
    network: hre.network.name,
    deployTime: new Date().toISOString()
  };
  
  fs.writeFileSync(
    './deployment.json',
    JSON.stringify(deployInfo, null, 2)
  );

  console.log("ÈÉ®ÁΩ≤‰ø°ÊÅØÂ∑≤‰øùÂ≠òÂà∞ deployment.json");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

---

## üß™ ÊµãËØïÁî®‰æã

### test/SupplyChainFinance.test.js

```javascript
const { expect } = require("chai");
const { ethers } = require("hardhat");

describe("SupplyChainFinance", function () {
  let contract;
  let coreCompany, supplier, financier;

  beforeEach(async function () {
    [coreCompany, supplier, financier] = await ethers.getSigners();

    const SupplyChainFinance = await ethers.getContractFactory("SupplyChainFinance");
    contract = await SupplyChainFinance.deploy();
    await contract.waitForDeployment();

    // Ê≥®ÂÜåÁî®Êà∑
    await contract.connect(coreCompany).registerUser(1, "Core Company A");
    await contract.connect(supplier).registerUser(2, "Supplier B");
    await contract.connect(financier).registerUser(3, "Bank C");
  });

  it("Â∫îËØ•ÊàêÂäüÊ≥®ÂÜåÁî®Êà∑", async function () {
    const role = await contract.getUserRole(coreCompany.address);
    expect(role).to.equal(1); // CORE_COMPANY
  });

  it("Â∫îËØ•ÊàêÂäüÂàõÂª∫Â∫îÊî∂Ë¥¶Ê¨æ", async function () {
    const amount = ethers.parseEther("100");
    const dueTime = Math.floor(Date.now() / 1000) + 86400 * 30; // 30Â§©Âêé

    await contract.connect(coreCompany).createReceivable(
      supplier.address,
      amount,
      dueTime,
      "Payment for goods",
      "CONTRACT-001"
    );

    const receivable = await contract.getReceivable(1);
    expect(receivable.amount).to.equal(amount);
    expect(receivable.owner).to.equal(supplier.address);
  });

  it("Â∫îËØ•ÊàêÂäüÁ°ÆËÆ§Â∫îÊî∂Ë¥¶Ê¨æ", async function () {
    const amount = ethers.parseEther("100");
    const dueTime = Math.floor(Date.now() / 1000) + 86400 * 30;

    await contract.connect(coreCompany).createReceivable(
      supplier.address,
      amount,
      dueTime,
      "Payment for goods",
      "CONTRACT-001"
    );

    await contract.connect(supplier).confirmReceivable(1);

    const receivable = await contract.getReceivable(1);
    expect(receivable.confirmed).to.be.true;
  });

  it("Â∫îËØ•ÊàêÂäüËΩ¨ËÆ©Â∫îÊî∂Ë¥¶Ê¨æ", async function () {
    const amount = ethers.parseEther("100");
    const dueTime = Math.floor(Date.now() / 1000) + 86400 * 30;

    await contract.connect(coreCompany).createReceivable(
      supplier.address,
      amount,
      dueTime,
      "Payment for goods",
      "CONTRACT-001"
    );

    await contract.connect(supplier).confirmReceivable(1);
    await contract.connect(supplier).transferReceivable(1, financier.address);

    const receivable = await contract.getReceivable(1);
    expect(receivable.owner).to.equal(financier.address);
  });

  it("Â∫îËØ•ÊàêÂäüÁî≥ËØ∑ÂíåÂÆ°ÊâπËûçËµÑ", async function () {
    const amount = ethers.parseEther("100");
    const dueTime = Math.floor(Date.now() / 1000) + 86400 * 30;

    await contract.connect(coreCompany).createReceivable(
      supplier.address,
      amount,
      dueTime,
      "Payment for goods",
      "CONTRACT-001"
    );

    await contract.connect(supplier).confirmReceivable(1);

    const financeAmount = ethers.parseEther("80");
    await contract.connect(supplier).applyForFinance(
      1,
      financier.address,
      financeAmount,
      500 // 5% Âà©Áéá
    );

    await contract.connect(financier).approveFinanceApplication(1, true);

    const receivable = await contract.getReceivable(1);
    expect(receivable.financed).to.be.true;
  });
});
```

---

## üìù ÂºÄÂèëÊ≠•È™§

1. **ÂàùÂßãÂåñ Hardhat È°πÁõÆ** (10ÂàÜÈíü)
2. **ÁºñÂÜô SupplyChainFinance.sol ÂêàÁ∫¶** (1-2Â∞èÊó∂)
3. **ÁºñÂÜôÊµãËØïÁî®‰æã** (30ÂàÜÈíü)
4. **Êú¨Âú∞ÊµãËØïÈÉ®ÁΩ≤** (20ÂàÜÈíü)
5. **ÈÉ®ÁΩ≤Âà∞ÊµãËØïÁΩë** (20ÂàÜÈíü)
6. **ÂØºÂá∫ ABI ‰æõÂâçÁ´Ø‰ΩøÁî®** (10ÂàÜÈíü)

**È¢ÑËÆ°ÊÄªÊó∂Èó¥Ôºö3-4Â∞èÊó∂**

---

## üéÅ ‰∫§‰ªòÁâ©

- [x] SupplyChainFinance.sol ÂêàÁ∫¶Ê∫êÁ†Å
- [x] ÈÉ®ÁΩ≤ËÑöÊú¨
- [x] ÊµãËØïÁî®‰æã
- [x] Hardhat ÈÖçÁΩÆÊñá‰ª∂
- [x] ÂêàÁ∫¶ ABI JSON Êñá‰ª∂
- [x] ÈÉ®ÁΩ≤Âú∞ÂùÄËÆ∞ÂΩïÊñá‰ª∂

---

## ‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ°π

1. **Gas ‰ºòÂåñ**: ÈÅøÂÖçÂú®Âæ™ÁéØ‰∏≠ËøõË°åÁä∂ÊÄÅÂÜôÂÖ•Êìç‰Ωú
2. **ÂÆâÂÖ®ÊÄß**: ÊâÄÊúâÂ§ñÈÉ®Ë∞ÉÁî®ÈÉΩË¶ÅËøõË°åÊùÉÈôêÊ£ÄÊü•
3. **‰∫ã‰ª∂Êó•Âøó**: ÂÖ≥ÈîÆÊìç‰ΩúÂøÖÈ°ªËß¶Âèë‰∫ã‰ª∂Ôºå‰æø‰∫éÂâçÁ´ØÁõëÂê¨
4. **ÊµãËØïÁΩëÊµãËØï**: ÈÉ®ÁΩ≤ÂâçÂä°ÂøÖÂú®ÊµãËØïÁΩëÂÖÖÂàÜÊµãËØï
5. **ÁßÅÈí•ÂÆâÂÖ®**: ‰ΩøÁî® .env Êñá‰ª∂ÁÆ°ÁêÜÁßÅÈí•Ôºå‰∏çË¶ÅÊèê‰∫§Âà∞ Git

---

## üîó Áõ∏ÂÖ≥ËµÑÊ∫ê

- Hardhat ÊñáÊ°£: https://hardhat.org/docs
- Solidity ÊñáÊ°£: https://docs.soliditylang.org
- OpenZeppelin: https://docs.openzeppelin.com
- Sepolia ÊµãËØïÁΩëÊ∞¥ÈæôÂ§¥: https://sepoliafaucet.com

