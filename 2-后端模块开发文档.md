# åç«¯æ¨¡å—å¼€å‘æ–‡æ¡£

## ğŸ“Œ æ¨¡å—æ¦‚è¿°

**åç«¯æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒ**ï¼Œè´Ÿè´£ä¸šåŠ¡é€»è¾‘å¤„ç†ã€æƒé™æ§åˆ¶ã€ä¸æ™ºèƒ½åˆçº¦äº¤äº’ã€‚å‰ç«¯é€šè¿‡åç«¯APIæ“ä½œï¼Œä¸ç›´æ¥è°ƒç”¨æ™ºèƒ½åˆçº¦ã€‚

---

## ğŸ¯ å¼€å‘ç›®æ ‡

- **ç»Ÿä¸€ä¸šåŠ¡å…¥å£**ï¼šå‰ç«¯æ‰€æœ‰æ“ä½œé€šè¿‡åç«¯API
- **æƒé™æ§åˆ¶**ï¼šåŸºäºJWTçš„èº«ä»½è®¤è¯å’Œè§’è‰²æƒé™ç®¡ç†
- **æ™ºèƒ½åˆçº¦ä»£ç†**ï¼šåç«¯æ‰˜ç®¡è´¦æˆ·ï¼Œç»Ÿä¸€ä¸åŒºå—é“¾äº¤äº’
- **æ•°æ®ç¼“å­˜ä¼˜åŒ–**ï¼šç¼“å­˜é“¾ä¸Šæ•°æ®ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡
- **ä¸šåŠ¡é€»è¾‘å¤„ç†**ï¼šå‚æ•°éªŒè¯ã€æ•°æ®æ ¡éªŒã€é€šçŸ¥å‘é€ç­‰
- **äº¤æ˜“ç®¡ç†**ï¼šäº¤æ˜“çŠ¶æ€è¿½è¸ªã€å¤±è´¥é‡è¯•ã€å†å²è®°å½•

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **è¿è¡Œç¯å¢ƒ**: Node.js 18+
- **Webæ¡†æ¶**: Express.js
- **æ•°æ®åº“**: MySQL 8.0
- **ORM**: Sequelize
- **Web3åº“**: ethers.js
- **å…¶ä»–å·¥å…·**: 
  - dotenv (ç¯å¢ƒå˜é‡ç®¡ç†)
  - cors (è·¨åŸŸæ”¯æŒ)
  - morgan (æ—¥å¿—è®°å½•)
  - joi (å‚æ•°æ ¡éªŒ)
  - jsonwebtoken (JWTè®¤è¯)
  - bcrypt (å¯†ç åŠ å¯†ï¼Œå¯é€‰)

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### 1. ç”¨æˆ·è¡¨ (users)

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    wallet_address VARCHAR(42) UNIQUE NOT NULL,
    role ENUM('core_company', 'supplier', 'financier') NOT NULL,
    company_name VARCHAR(100) NOT NULL,
    contact_person VARCHAR(50),
    contact_phone VARCHAR(20),
    contact_email VARCHAR(100),
    credit_rating INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_wallet (wallet_address),
    INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 2. åº”æ”¶è´¦æ¬¾ç´¢å¼•è¡¨ (receivables_index)

```sql
CREATE TABLE receivables_index (
    id INT AUTO_INCREMENT PRIMARY KEY,
    receivable_id INT UNIQUE NOT NULL,
    issuer_address VARCHAR(42) NOT NULL,
    owner_address VARCHAR(42) NOT NULL,
    supplier_address VARCHAR(42) NOT NULL,
    amount DECIMAL(30, 0) NOT NULL,
    contract_number VARCHAR(100),
    description TEXT,
    create_time TIMESTAMP,
    due_time TIMESTAMP,
    confirmed BOOLEAN DEFAULT FALSE,
    financed BOOLEAN DEFAULT FALSE,
    settled BOOLEAN DEFAULT FALSE,
    tx_hash VARCHAR(66),
    block_number INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_receivable_id (receivable_id),
    INDEX idx_issuer (issuer_address),
    INDEX idx_owner (owner_address),
    INDEX idx_supplier (supplier_address),
    INDEX idx_status (confirmed, financed, settled)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3. èèµ„ç”³è¯·ç´¢å¼•è¡¨ (finance_applications_index)

```sql
CREATE TABLE finance_applications_index (
    id INT AUTO_INCREMENT PRIMARY KEY,
    application_id INT UNIQUE NOT NULL,
    receivable_id INT NOT NULL,
    applicant_address VARCHAR(42) NOT NULL,
    financier_address VARCHAR(42) NOT NULL,
    finance_amount DECIMAL(30, 0) NOT NULL,
    interest_rate INT NOT NULL,
    apply_time TIMESTAMP,
    approved BOOLEAN DEFAULT FALSE,
    processed BOOLEAN DEFAULT FALSE,
    tx_hash VARCHAR(66),
    block_number INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_application_id (application_id),
    INDEX idx_receivable (receivable_id),
    INDEX idx_applicant (applicant_address),
    INDEX idx_financier (financier_address),
    INDEX idx_status (processed, approved)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 4. äº¤æ˜“å†å²è¡¨ (transaction_history)

```sql
CREATE TABLE transaction_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    tx_hash VARCHAR(66) UNIQUE NOT NULL,
    from_address VARCHAR(42) NOT NULL,
    to_address VARCHAR(42),
    tx_type ENUM('create', 'confirm', 'transfer', 'apply_finance', 'approve_finance', 'settle') NOT NULL,
    related_id INT,
    block_number INT,
    gas_used INT,
    timestamp TIMESTAMP,
    status ENUM('pending', 'success', 'failed') DEFAULT 'pending',
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_tx_hash (tx_hash),
    INDEX idx_from (from_address),
    INDEX idx_type (tx_type),
    INDEX idx_related (related_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 5. ç³»ç»Ÿé…ç½®è¡¨ (system_config)

```sql
CREATE TABLE system_config (
    id INT AUTO_INCREMENT PRIMARY KEY,
    config_key VARCHAR(50) UNIQUE NOT NULL,
    config_value TEXT,
    description VARCHAR(200),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- æ’å…¥åˆå§‹é…ç½®
INSERT INTO system_config (config_key, config_value, description) VALUES
('contract_address', '', 'æ™ºèƒ½åˆçº¦åœ°å€'),
('network_id', '1337', 'ç½‘ç»œID'),
('last_synced_block', '0', 'æœ€ååŒæ­¥çš„åŒºå—å·');
```

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ database.js          # æ•°æ®åº“é…ç½®
â”‚   â”‚   â”œâ”€â”€ web3.js              # Web3é…ç½®
â”‚   â”‚   â””â”€â”€ contract.js          # åˆçº¦é…ç½®
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ User.js              # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ ReceivableIndex.js  # åº”æ”¶è´¦æ¬¾ç´¢å¼•æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ FinanceAppIndex.js  # èèµ„ç”³è¯·ç´¢å¼•æ¨¡å‹
â”‚   â”‚   â””â”€â”€ TransactionHistory.js # äº¤æ˜“å†å²æ¨¡å‹
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ userController.js    # ç”¨æˆ·æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ receivableController.js # åº”æ”¶è´¦æ¬¾æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ financeController.js # èèµ„æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ statsController.js   # ç»Ÿè®¡æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ web3Service.js       # Web3æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ contractService.js   # åˆçº¦äº¤äº’æœåŠ¡
â”‚   â”‚   â””â”€â”€ syncService.js       # åŒºå—é“¾åŒæ­¥æœåŠ¡
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ index.js             # è·¯ç”±æ±‡æ€»
â”‚   â”‚   â”œâ”€â”€ authRoutes.js        # è®¤è¯è·¯ç”±ï¼ˆç™»å½•/æ³¨å†Œï¼‰
â”‚   â”‚   â”œâ”€â”€ receivableRoutes.js # åº”æ”¶è´¦æ¬¾è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ financeRoutes.js    # èèµ„è·¯ç”±
â”‚   â”‚   â””â”€â”€ statsRoutes.js      # ç»Ÿè®¡è·¯ç”±
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ auth.js              # JWTè®¤è¯ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ roleCheck.js         # è§’è‰²æƒé™ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ validator.js         # å‚æ•°æ ¡éªŒä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ errorHandler.js     # é”™è¯¯å¤„ç†ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ logger.js            # æ—¥å¿—å·¥å…·
â”‚   â”‚   â””â”€â”€ response.js          # å“åº”æ ¼å¼åŒ–å·¥å…·
â”‚   â””â”€â”€ app.js                   # åº”ç”¨å…¥å£
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ initDB.js                # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ .env.example                 # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. åˆçº¦æœåŠ¡å°è£… (services/contractService.js)

**é‡è¦ï¼šåç«¯ä½¿ç”¨æ‰˜ç®¡è´¦æˆ·ä¸æ™ºèƒ½åˆçº¦äº¤äº’ï¼Œå‰ç«¯ä¸ç›´æ¥è°ƒç”¨åˆçº¦**

```javascript
const { ethers } = require('ethers');
const contractABI = require('../contracts/SupplyChainFinance.json');

class Web3Service {
  constructor() {
    this.provider = new ethers.JsonRpcProvider(process.env.RPC_URL);
    this.contractAddress = process.env.CONTRACT_ADDRESS;
    this.contract = new ethers.Contract(
      this.contractAddress,
      contractABI.abi,
      this.provider
    );
  }

  // è·å–åˆçº¦å®ä¾‹ï¼ˆå¸¦ç­¾åè€…ï¼‰
  getContractWithSigner(privateKey) {
    const wallet = new ethers.Wallet(privateKey, this.provider);
    return new ethers.Contract(
      this.contractAddress,
      contractABI.abi,
      wallet
    );
  }

  // ç›‘å¬åˆçº¦äº‹ä»¶
  async listenToEvents() {
    // ç›‘å¬åº”æ”¶è´¦æ¬¾åˆ›å»ºäº‹ä»¶
    this.contract.on('ReceivableCreated', async (id, issuer, supplier, amount, event) => {
      console.log('ReceivableCreated:', { id, issuer, supplier, amount: amount.toString() });
      await this.syncReceivable(id);
    });

    // ç›‘å¬åº”æ”¶è´¦æ¬¾ç¡®è®¤äº‹ä»¶
    this.contract.on('ReceivableConfirmed', async (id, confirmer, event) => {
      console.log('ReceivableConfirmed:', { id, confirmer });
      await this.syncReceivable(id);
    });

    // ç›‘å¬åº”æ”¶è´¦æ¬¾è½¬è®©äº‹ä»¶
    this.contract.on('ReceivableTransferred', async (id, from, to, event) => {
      console.log('ReceivableTransferred:', { id, from, to });
      await this.syncReceivable(id);
    });

    console.log('å¼€å§‹ç›‘å¬åˆçº¦äº‹ä»¶...');
  }

  // åŒæ­¥åº”æ”¶è´¦æ¬¾æ•°æ®
  async syncReceivable(id) {
    const receivable = await this.contract.getReceivable(id);
    // ä¿å­˜åˆ°æ•°æ®åº“çš„é€»è¾‘
    // ... (åœ¨ syncService ä¸­å®ç°)
  }

  // è·å–åº”æ”¶è´¦æ¬¾è¯¦æƒ…
  async getReceivable(id) {
    return await this.contract.getReceivable(id);
  }

  // è·å–ç”¨æˆ·è§’è‰²
  async getUserRole(address) {
    return await this.contract.getUserRole(address);
  }

  // è·å–ç”¨æˆ·çš„åº”æ”¶è´¦æ¬¾åˆ—è¡¨
  async getReceivablesByOwner(address) {
    return await this.contract.getReceivablesByOwner(address);
  }

  // è·å–ç”¨æˆ·å‘è¡Œçš„åº”æ”¶è´¦æ¬¾åˆ—è¡¨
  async getReceivablesByIssuer(address) {
    return await this.contract.getReceivablesByIssuer(address);
  }
}

module.exports = new Web3Service();
```

### 2. åº”æ”¶è´¦æ¬¾æ§åˆ¶å™¨ (controllers/receivableController.js)

```javascript
const web3Service = require('../services/web3Service');
const ReceivableIndex = require('../models/ReceivableIndex');
const { ethers } = require('ethers');

class ReceivableController {
  // è·å–åº”æ”¶è´¦æ¬¾åˆ—è¡¨
  async getReceivables(req, res, next) {
    try {
      const { owner, issuer, status, page = 1, limit = 10 } = req.query;
      
      const where = {};
      if (owner) where.owner_address = owner;
      if (issuer) where.issuer_address = issuer;
      if (status === 'confirmed') where.confirmed = true;
      if (status === 'financed') where.financed = true;
      if (status === 'settled') where.settled = true;

      const offset = (page - 1) * limit;

      const { count, rows } = await ReceivableIndex.findAndCountAll({
        where,
        limit: parseInt(limit),
        offset: parseInt(offset),
        order: [['created_at', 'DESC']]
      });

      res.json({
        success: true,
        data: {
          total: count,
          page: parseInt(page),
          pageSize: parseInt(limit),
          items: rows
        }
      });
    } catch (error) {
      next(error);
    }
  }

  // è·å–åº”æ”¶è´¦æ¬¾è¯¦æƒ…
  async getReceivableDetail(req, res, next) {
    try {
      const { id } = req.params;

      // ä»æ•°æ®åº“è·å–
      const dbData = await ReceivableIndex.findOne({
        where: { receivable_id: id }
      });

      // ä»é“¾ä¸Šè·å–æœ€æ–°æ•°æ®
      const chainData = await web3Service.getReceivable(id);

      res.json({
        success: true,
        data: {
          db: dbData,
          chain: {
            id: chainData.id.toString(),
            issuer: chainData.issuer,
            owner: chainData.owner,
            supplier: chainData.supplier,
            amount: chainData.amount.toString(),
            createTime: new Date(Number(chainData.createTime) * 1000),
            dueTime: new Date(Number(chainData.dueTime) * 1000),
            confirmed: chainData.confirmed,
            financed: chainData.financed,
            settled: chainData.settled,
            description: chainData.description,
            contractNumber: chainData.contractNumber
          }
        }
      });
    } catch (error) {
      next(error);
    }
  }

  // åˆ›å»ºåº”æ”¶è´¦æ¬¾ï¼ˆå‡†å¤‡äº¤æ˜“æ•°æ®ï¼‰
  async prepareCreateReceivable(req, res, next) {
    try {
      const { supplier, amount, dueTime, description, contractNumber } = req.body;

      // å‚æ•°æ ¡éªŒ
      if (!ethers.isAddress(supplier)) {
        return res.status(400).json({
          success: false,
          message: 'æ— æ•ˆçš„ä¾›åº”å•†åœ°å€'
        });
      }

      // è¿”å›äº¤æ˜“æ•°æ®ä¾›å‰ç«¯ç­¾å
      const contractABI = require('../contracts/SupplyChainFinance.json');
      const iface = new ethers.Interface(contractABI.abi);
      
      const data = iface.encodeFunctionData('createReceivable', [
        supplier,
        ethers.parseEther(amount.toString()),
        Math.floor(new Date(dueTime).getTime() / 1000),
        description,
        contractNumber
      ]);

      res.json({
        success: true,
        data: {
          to: process.env.CONTRACT_ADDRESS,
          data: data
        }
      });
    } catch (error) {
      next(error);
    }
  }

  // ç¡®è®¤äº¤æ˜“å·²æäº¤
  async confirmTransaction(req, res, next) {
    try {
      const { txHash, type, relatedId } = req.body;

      // ä¿å­˜äº¤æ˜“è®°å½•
      const TransactionHistory = require('../models/TransactionHistory');
      await TransactionHistory.create({
        tx_hash: txHash,
        from_address: req.body.from,
        to_address: process.env.CONTRACT_ADDRESS,
        tx_type: type,
        related_id: relatedId,
        status: 'pending'
      });

      // ç­‰å¾…äº¤æ˜“ç¡®è®¤
      const receipt = await web3Service.provider.waitForTransaction(txHash);

      if (receipt.status === 1) {
        // æ›´æ–°äº¤æ˜“çŠ¶æ€
        await TransactionHistory.update(
          {
            status: 'success',
            block_number: receipt.blockNumber,
            gas_used: receipt.gasUsed.toString()
          },
          { where: { tx_hash: txHash } }
        );

        res.json({
          success: true,
          message: 'äº¤æ˜“ç¡®è®¤æˆåŠŸ',
          data: receipt
        });
      } else {
        await TransactionHistory.update(
          { status: 'failed' },
          { where: { tx_hash: txHash } }
        );

        res.status(400).json({
          success: false,
          message: 'äº¤æ˜“æ‰§è¡Œå¤±è´¥'
        });
      }
    } catch (error) {
      next(error);
    }
  }

  // è·å–ç”¨æˆ·çš„åº”æ”¶è´¦æ¬¾ç»Ÿè®¡
  async getUserStats(req, res, next) {
    try {
      const { address } = req.params;

      const stats = await ReceivableIndex.findAll({
        where: { owner_address: address },
        attributes: [
          [sequelize.fn('COUNT', sequelize.col('id')), 'total'],
          [sequelize.fn('SUM', sequelize.col('amount')), 'totalAmount'],
          [sequelize.fn('COUNT', sequelize.literal('CASE WHEN confirmed = 1 THEN 1 END')), 'confirmedCount'],
          [sequelize.fn('COUNT', sequelize.literal('CASE WHEN financed = 1 THEN 1 END')), 'financedCount']
        ]
      });

      res.json({
        success: true,
        data: stats[0]
      });
    } catch (error) {
      next(error);
    }
  }
}

module.exports = new ReceivableController();
```

### 3. èèµ„æ§åˆ¶å™¨ (controllers/financeController.js)

```javascript
const web3Service = require('../services/web3Service');
const FinanceAppIndex = require('../models/FinanceAppIndex');
const { ethers } = require('ethers');

class FinanceController {
  // è·å–èèµ„ç”³è¯·åˆ—è¡¨
  async getFinanceApplications(req, res, next) {
    try {
      const { applicant, financier, receivableId, status, page = 1, limit = 10 } = req.query;
      
      const where = {};
      if (applicant) where.applicant_address = applicant;
      if (financier) where.financier_address = financier;
      if (receivableId) where.receivable_id = receivableId;
      if (status === 'pending') where.processed = false;
      if (status === 'approved') {
        where.processed = true;
        where.approved = true;
      }
      if (status === 'rejected') {
        where.processed = true;
        where.approved = false;
      }

      const offset = (page - 1) * limit;

      const { count, rows } = await FinanceAppIndex.findAndCountAll({
        where,
        limit: parseInt(limit),
        offset: parseInt(offset),
        order: [['created_at', 'DESC']]
      });

      res.json({
        success: true,
        data: {
          total: count,
          page: parseInt(page),
          pageSize: parseInt(limit),
          items: rows
        }
      });
    } catch (error) {
      next(error);
    }
  }

  // å‡†å¤‡èèµ„ç”³è¯·äº¤æ˜“
  async prepareApplyFinance(req, res, next) {
    try {
      const { receivableId, financier, financeAmount, interestRate } = req.body;

      const contractABI = require('../contracts/SupplyChainFinance.json');
      const iface = new ethers.Interface(contractABI.abi);
      
      const data = iface.encodeFunctionData('applyForFinance', [
        receivableId,
        financier,
        ethers.parseEther(financeAmount.toString()),
        interestRate
      ]);

      res.json({
        success: true,
        data: {
          to: process.env.CONTRACT_ADDRESS,
          data: data
        }
      });
    } catch (error) {
      next(error);
    }
  }

  // å‡†å¤‡å®¡æ‰¹èèµ„äº¤æ˜“
  async prepareApproveFinance(req, res, next) {
    try {
      const { applicationId, approve } = req.body;

      const contractABI = require('../contracts/SupplyChainFinance.json');
      const iface = new ethers.Interface(contractABI.abi);
      
      const data = iface.encodeFunctionData('approveFinanceApplication', [
        applicationId,
        approve
      ]);

      res.json({
        success: true,
        data: {
          to: process.env.CONTRACT_ADDRESS,
          data: data
        }
      });
    } catch (error) {
      next(error);
    }
  }
}

module.exports = new FinanceController();
```

### 4. åŒºå—é“¾åŒæ­¥æœåŠ¡ (services/syncService.js)

```javascript
const web3Service = require('./web3Service');
const ReceivableIndex = require('../models/ReceivableIndex');
const FinanceAppIndex = require('../models/FinanceAppIndex');
const SystemConfig = require('../models/SystemConfig');

class SyncService {
  constructor() {
    this.isSyncing = false;
  }

  // å¯åŠ¨åŒæ­¥æœåŠ¡
  async start() {
    console.log('å¯åŠ¨åŒºå—é“¾åŒæ­¥æœåŠ¡...');
    
    // ç›‘å¬å®æ—¶äº‹ä»¶
    await web3Service.listenToEvents();

    // å®šæœŸåŒæ­¥å†å²æ•°æ®
    setInterval(() => {
      this.syncHistoricalData();
    }, 60000); // æ¯åˆ†é’ŸåŒæ­¥ä¸€æ¬¡

    // ç«‹å³æ‰§è¡Œä¸€æ¬¡åŒæ­¥
    await this.syncHistoricalData();
  }

  // åŒæ­¥å†å²æ•°æ®
  async syncHistoricalData() {
    if (this.isSyncing) {
      console.log('åŒæ­¥è¿›è¡Œä¸­ï¼Œè·³è¿‡æœ¬æ¬¡åŒæ­¥');
      return;
    }

    this.isSyncing = true;

    try {
      console.log('å¼€å§‹åŒæ­¥å†å²æ•°æ®...');

      const receivableCounter = await web3Service.contract.receivableCounter();
      const totalReceivables = Number(receivableCounter);

      for (let i = 1; i <= totalReceivables; i++) {
        await this.syncReceivable(i);
      }

      console.log(`åŒæ­¥å®Œæˆï¼Œå…±åŒæ­¥ ${totalReceivables} æ¡åº”æ”¶è´¦æ¬¾`);
    } catch (error) {
      console.error('åŒæ­¥å¤±è´¥:', error);
    } finally {
      this.isSyncing = false;
    }
  }

  // åŒæ­¥å•ä¸ªåº”æ”¶è´¦æ¬¾
  async syncReceivable(id) {
    try {
      const receivable = await web3Service.contract.getReceivable(id);

      if (receivable.id === 0n) {
        return; // ä¸å­˜åœ¨çš„åº”æ”¶è´¦æ¬¾
      }

      await ReceivableIndex.upsert({
        receivable_id: Number(receivable.id),
        issuer_address: receivable.issuer,
        owner_address: receivable.owner,
        supplier_address: receivable.supplier,
        amount: receivable.amount.toString(),
        contract_number: receivable.contractNumber,
        description: receivable.description,
        create_time: new Date(Number(receivable.createTime) * 1000),
        due_time: new Date(Number(receivable.dueTime) * 1000),
        confirmed: receivable.confirmed,
        financed: receivable.financed,
        settled: receivable.settled
      });

      console.log(`åŒæ­¥åº”æ”¶è´¦æ¬¾ #${id} æˆåŠŸ`);
    } catch (error) {
      console.error(`åŒæ­¥åº”æ”¶è´¦æ¬¾ #${id} å¤±è´¥:`, error);
    }
  }
}

module.exports = new SyncService();
```

---

## ğŸŒ API æ¥å£è®¾è®¡

### 1. ç”¨æˆ·ç›¸å…³

```
POST   /api/users/register          # æ³¨å†Œç”¨æˆ·
GET    /api/users/:address          # è·å–ç”¨æˆ·ä¿¡æ¯
PUT    /api/users/:address          # æ›´æ–°ç”¨æˆ·ä¿¡æ¯
GET    /api/users/:address/role     # è·å–ç”¨æˆ·è§’è‰²
```

### 2. åº”æ”¶è´¦æ¬¾ç›¸å…³

```
GET    /api/receivables             # è·å–åº”æ”¶è´¦æ¬¾åˆ—è¡¨
GET    /api/receivables/:id         # è·å–åº”æ”¶è´¦æ¬¾è¯¦æƒ…
POST   /api/receivables/prepare     # å‡†å¤‡åˆ›å»ºåº”æ”¶è´¦æ¬¾äº¤æ˜“
POST   /api/receivables/confirm-tx  # ç¡®è®¤äº¤æ˜“å·²æäº¤
GET    /api/receivables/stats/:address  # è·å–ç”¨æˆ·ç»Ÿè®¡
```

### 3. èèµ„ç›¸å…³

```
GET    /api/finance/applications    # è·å–èèµ„ç”³è¯·åˆ—è¡¨
GET    /api/finance/applications/:id # è·å–èèµ„ç”³è¯·è¯¦æƒ…
POST   /api/finance/prepare-apply   # å‡†å¤‡èèµ„ç”³è¯·äº¤æ˜“
POST   /api/finance/prepare-approve # å‡†å¤‡å®¡æ‰¹èèµ„äº¤æ˜“
```

### 4. äº¤æ˜“å†å²

```
GET    /api/transactions            # è·å–äº¤æ˜“å†å²
GET    /api/transactions/:hash      # è·å–äº¤æ˜“è¯¦æƒ…
```

---

## ğŸ“ å¼€å‘æ­¥éª¤

1. **åˆå§‹åŒ–é¡¹ç›®** (15åˆ†é’Ÿ)
   ```bash
   mkdir backend && cd backend
   npm init -y
   npm install express sequelize mysql2 ethers dotenv cors morgan joi
   ```

2. **é…ç½®æ•°æ®åº“** (20åˆ†é’Ÿ)
   - åˆ›å»ºæ•°æ®åº“
   - è¿è¡Œ SQL è„šæœ¬
   - é…ç½® Sequelize è¿æ¥

3. **åˆ›å»ºæ¨¡å‹** (30åˆ†é’Ÿ)
   - User, ReceivableIndex, FinanceAppIndex, TransactionHistory

4. **å®ç°æœåŠ¡å±‚** (1å°æ—¶)
   - Web3Service
   - SyncService

5. **å®ç°æ§åˆ¶å™¨** (1.5å°æ—¶)
   - UserController
   - ReceivableController
   - FinanceController

6. **é…ç½®è·¯ç”±** (30åˆ†é’Ÿ)

7. **æµ‹è¯•æ¥å£** (30åˆ†é’Ÿ)

**é¢„è®¡æ€»æ—¶é—´ï¼š4-5å°æ—¶**

---

## ğŸ äº¤ä»˜ç‰©

- [x] å®Œæ•´çš„ Node.js åç«¯é¡¹ç›®
- [x] æ•°æ®åº“ SQL è„šæœ¬
- [x] API æ–‡æ¡£
- [x] ç¯å¢ƒé…ç½®ç¤ºä¾‹æ–‡ä»¶
- [x] å¯åŠ¨è„šæœ¬

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡ç®¡ç†**: ä½¿ç”¨ .env æ–‡ä»¶ï¼Œä¸è¦æäº¤æ•æ„Ÿä¿¡æ¯
2. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶
3. **æ—¥å¿—è®°å½•**: è®°å½•å…³é”®æ“ä½œå’Œé”™è¯¯ä¿¡æ¯
4. **å‚æ•°æ ¡éªŒ**: ä½¿ç”¨ Joi è¿›è¡Œä¸¥æ ¼çš„å‚æ•°æ ¡éªŒ
5. **æ•°æ®åº“ç´¢å¼•**: åˆç†ä½¿ç”¨ç´¢å¼•æå‡æŸ¥è¯¢æ€§èƒ½
6. **äº‹åŠ¡å¤„ç†**: å…³é”®æ“ä½œä½¿ç”¨æ•°æ®åº“äº‹åŠ¡

---

## ğŸ”— ç›¸å…³èµ„æº

- Express.js: https://expressjs.com
- Sequelize: https://sequelize.org
- ethers.js: https://docs.ethers.org

