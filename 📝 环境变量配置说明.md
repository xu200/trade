# 📝 环境变量配置说明

## 🎯 需要更新合约地址的地方

### ✅ 新部署的合约地址
```
0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9
```

---

## 1️⃣ 后端环境变量

**文件**: `backend/.env`

**创建方法**:
```bash
cd backend
# 创建 .env 文件并添加以下内容
```

**内容**:
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=supply_chain_finance
DB_USER=root
DB_PASSWORD=your_password

# JWT密钥
JWT_SECRET=your_jwt_secret_key_here_please_change_in_production

# 服务器端口
PORT=5000

# 区块链配置 ⭐ 重点
RPC_URL=http://127.0.0.1:8545
CONTRACT_ADDRESS=0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9
PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

# API配置
NODE_ENV=development
```

**说明**:
- `CONTRACT_ADDRESS`: ⭐ 新部署的合约地址
- `PRIVATE_KEY`: 后端用于调用合约的私钥 (Hardhat账户#0)
- `RPC_URL`: Hardhat本地节点地址

---

## 2️⃣ 前端环境变量

**文件**: `frontend/.env` 或 `frontend/.env.local`

**创建方法**:
```bash
cd frontend
# 创建 .env.local 文件并添加以下内容
```

**内容**:
```env
# 合约地址 ⭐ 重点
VITE_CONTRACT_ADDRESS=0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9

# 后端API地址
VITE_API_BASE_URL=http://localhost:5000/api
```

**说明**:
- `VITE_CONTRACT_ADDRESS`: ⭐ 新部署的合约地址 (前端MetaMask调用)
- `VITE_API_BASE_URL`: 后端API地址

---

## 3️⃣ 前端合约服务 (已自动配置默认值)

**文件**: `frontend/src/services/contract.ts`

**当前代码**:
```typescript
const CONTRACT_ADDRESS = import.meta.env.VITE_CONTRACT_ADDRESS || '0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512';
```

**说明**:
- 如果设置了环境变量 `VITE_CONTRACT_ADDRESS`，则使用环境变量
- 否则使用默认值
- ⭐ **建议**: 创建 `.env.local` 文件设置正确的地址

---

## 4️⃣ Hardhat测试账户私钥

**用途**: 后端调用合约需要签名

**Hardhat默认账户**:
```
Account #0: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 (10000 ETH)
Private Key: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

Account #1: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 (10000 ETH)
Private Key: 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d

Account #2: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC (10000 ETH)
Private Key: 0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a
```

**配置到后端**:
```env
PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
```

---

## 5️⃣ MetaMask配置 (前端用户)

**网络配置**:
```
网络名称: Hardhat Local
RPC URL: http://127.0.0.1:8545
Chain ID: 31337
货币符号: ETH
```

**导入测试账户**:
1. 打开MetaMask
2. 导入账户 -> 输入私钥
3. 使用上面的 Account #1, #2, #3 等

**建议分配**:
- Account #0: 后端服务账户 (不导入MetaMask)
- Account #1: 核心企业测试账户
- Account #2: 供应商测试账户
- Account #3: 金融机构测试账户

---

## 📋 配置检查清单

### 后端配置
- [ ] 创建 `backend/.env` 文件
- [ ] 设置 `CONTRACT_ADDRESS=0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9`
- [ ] 设置 `PRIVATE_KEY` (Hardhat Account #0)
- [ ] 设置数据库连接信息
- [ ] 设置 JWT_SECRET

### 前端配置
- [ ] 创建 `frontend/.env.local` 文件
- [ ] 设置 `VITE_CONTRACT_ADDRESS=0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9`
- [ ] 设置 `VITE_API_BASE_URL=http://localhost:5000/api`

### MetaMask配置
- [ ] 添加 Hardhat Local 网络
- [ ] 导入测试账户 (Account #1, #2, #3)

### 服务启动
- [ ] 启动 Hardhat 节点: `cd contracts && npx hardhat node`
- [ ] 启动后端: `cd backend && npm run dev`
- [ ] 启动前端: `cd frontend && npm run dev`

---

## 🧪 验证配置

### 1. 验证后端连接合约
```bash
cd backend
node -e "
const { ethers } = require('ethers');
require('dotenv').config();
const provider = new ethers.JsonRpcProvider(process.env.RPC_URL);
provider.getCode(process.env.CONTRACT_ADDRESS).then(code => {
  console.log('合约代码长度:', code.length);
  console.log('配置正确!');
});
"
```

### 2. 验证前端环境变量
```bash
cd frontend
# 启动开发服务器后，在浏览器控制台运行:
console.log('合约地址:', import.meta.env.VITE_CONTRACT_ADDRESS);
```

---

## ⚠️ 重要提示

### 安全性
- ⚠️ **生产环境**: 绝对不要使用Hardhat默认私钥！
- ⚠️ **生产环境**: 使用强密码和安全的私钥管理
- ⚠️ `.env` 文件已在 `.gitignore` 中，不会提交到git

### 网络切换
- 本地开发: `http://127.0.0.1:8545` (Hardhat)
- 测试网: 需要更改 RPC_URL 和 CONTRACT_ADDRESS
- 主网: 需要更改 RPC_URL、CONTRACT_ADDRESS 和 PRIVATE_KEY

---

## 🚀 快速开始

### 一键配置脚本

**Linux/Mac**: 创建 `setup-env.sh`
```bash
#!/bin/bash

# 后端环境变量
cat > backend/.env << EOF
DB_HOST=localhost
DB_PORT=3306
DB_NAME=supply_chain_finance
DB_USER=root
DB_PASSWORD=your_password
JWT_SECRET=your_jwt_secret_key_here
PORT=5000
RPC_URL=http://127.0.0.1:8545
CONTRACT_ADDRESS=0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9
PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
NODE_ENV=development
EOF

# 前端环境变量
cat > frontend/.env.local << EOF
VITE_CONTRACT_ADDRESS=0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9
VITE_API_BASE_URL=http://localhost:5000/api
EOF

echo "✅ 环境变量配置完成！"
```

**Windows PowerShell**: 创建 `setup-env.ps1`
```powershell
# 后端环境变量
@"
DB_HOST=localhost
DB_PORT=3306
DB_NAME=supply_chain_finance
DB_USER=root
DB_PASSWORD=your_password
JWT_SECRET=your_jwt_secret_key_here
PORT=5000
RPC_URL=http://127.0.0.1:8545
CONTRACT_ADDRESS=0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9
PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
NODE_ENV=development
"@ | Out-File -FilePath backend\.env -Encoding UTF8

# 前端环境变量
@"
VITE_CONTRACT_ADDRESS=0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9
VITE_API_BASE_URL=http://localhost:5000/api
"@ | Out-File -FilePath frontend\.env.local -Encoding UTF8

Write-Host "✅ 环境变量配置完成！"
```

**运行**:
```bash
# Linux/Mac
chmod +x setup-env.sh
./setup-env.sh

# Windows
.\setup-env.ps1
```

---

**配置完成后，按照 📋 配置检查清单 验证所有项目！** ✅

